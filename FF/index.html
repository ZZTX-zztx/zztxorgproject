<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¼å¼å·¥å‚ - æµè§ˆå™¨æœ¬åœ°æ ¼å¼è½¬æ¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥FFmpeg WebAssemblyæ ¸å¿ƒåº“ -->
    <script type="module">
        import { FFmpeg } from 'https://esm.sh/@ffmpeg/ffmpeg@0.12.10';
        import { fetchFile, toBlobURL } from 'https://esm.sh/@ffmpeg/util@0.12.1';

        // å…¨å±€å˜é‡åˆå§‹åŒ–
        let ffmpeg = null;
        let isFFmpegLoaded = false;
        let selectedFiles = [];
        const outputFormats = {
            video: ['mp4', 'avi', 'mkv', 'webm', 'mov', 'flv'],
            audio: ['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a'],
            image: ['jpg', 'png', 'webp', 'gif', 'bmp', 'tiff']
        };
        let currentType = 'video';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = async () => {
            const statusText = document.getElementById('statusText');
            const loadBtn = document.getElementById('loadFFmpegBtn');
            
            // åˆå§‹åŒ–FFmpegå®ä¾‹
            ffmpeg = new FFmpeg();
            
            // ç›‘å¬FFmpegæ—¥å¿—
            ffmpeg.on('log', ({ message }) => {
                console.log(message);
                if (message.includes('Conversion failed')) {
                    statusText.textContent = 'è½¬æ¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–å‚æ•°';
                    statusText.className = 'text-red-500 text-sm mt-2';
                }
            });

            // ç›‘å¬è½¬æ¢è¿›åº¦
            ffmpeg.on('progress', ({ progress }) => {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const percent = Math.round(progress * 100);
                progressBar.style.width = `${percent}%`;
                progressText.textContent = `${percent}%`;
                if (percent === 100) {
                    statusText.textContent = 'è½¬æ¢å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆä¸‹è½½æ–‡ä»¶';
                    statusText.className = 'text-green-600 text-sm mt-2';
                }
            });

            // åŠ è½½FFmpegæ ¸å¿ƒ
            loadBtn.addEventListener('click', async () => {
                if (isFFmpegLoaded) return;
                loadBtn.disabled = true;
                loadBtn.textContent = 'æ­£åœ¨åŠ è½½æ ¸å¿ƒç»„ä»¶...';
                statusText.textContent = 'æ­£åœ¨åŠ è½½FFmpegè½¬æ¢æ ¸å¿ƒï¼Œé¦–æ¬¡åŠ è½½éœ€è¦ä¸€ç‚¹æ—¶é—´';
                statusText.className = 'text-blue-600 text-sm mt-2';

                try {
                    const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
                    await ffmpeg.load({
                        coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                        wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm')
                    });
                    isFFmpegLoaded = true;
                    loadBtn.textContent = 'âœ… æ ¸å¿ƒç»„ä»¶å·²åŠ è½½';
                    statusText.textContent = 'æ ¸å¿ƒåŠ è½½å®Œæˆï¼Œå¯å¼€å§‹è½¬æ¢æ–‡ä»¶';
                    statusText.className = 'text-green-600 text-sm mt-2';
                    document.getElementById('fileInput').disabled = false;
                    document.getElementById('formatSelect').disabled = false;
                    document.getElementById('convertBtn').disabled = false;
                } catch (error) {
                    console.error(error);
                    loadBtn.disabled = false;
                    loadBtn.textContent = 'âŒ åŠ è½½å¤±è´¥ï¼Œé‡è¯•';
                    statusText.textContent = 'æ ¸å¿ƒåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œåˆ·æ–°é¡µé¢é‡è¯•';
                    statusText.className = 'text-red-500 text-sm mt-2';
                }
            });

            // åˆ‡æ¢è½¬æ¢ç±»å‹
            const typeBtns = document.querySelectorAll('.type-btn');
            typeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    typeBtns.forEach(b => b.classList.remove('bg-blue-600', 'text-white'));
                    typeBtns.forEach(b => b.classList.add('bg-white', 'text-gray-700'));
                    btn.classList.remove('bg-white', 'text-gray-700');
                    btn.classList.add('bg-blue-600', 'text-white');
                    
                    currentType = btn.dataset.type;
                    // æ›´æ–°æ ¼å¼é€‰é¡¹
                    const formatSelect = document.getElementById('formatSelect');
                    formatSelect.innerHTML = '';
                    outputFormats[currentType].forEach(format => {
                        const option = document.createElement('option');
                        option.value = format;
                        option.textContent = format.toUpperCase();
                        formatSelect.appendChild(option);
                    });
                    // æ›´æ–°æ–‡ä»¶é€‰æ‹©å™¨æ¥å—ç±»å‹
                    const fileInput = document.getElementById('fileInput');
                    if (currentType === 'video') {
                        fileInput.accept = 'video/*';
                    } else if (currentType === 'audio') {
                        fileInput.accept = 'audio/*';
                    } else if (currentType === 'image') {
                        fileInput.accept = 'image/*';
                    }
                    // æ¸…ç©ºå·²é€‰æ–‡ä»¶
                    selectedFiles = [];
                    document.getElementById('fileList').innerHTML = '';
                });
            });

            // é€‰æ‹©æ–‡ä»¶
            const fileInput = document.getElementById('fileInput');
            const fileList = document.getElementById('fileList');
            fileInput.addEventListener('change', (e) => {
                selectedFiles = Array.from(e.target.files);
                fileList.innerHTML = '';
                if (selectedFiles.length === 0) return;
                
                selectedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex justify-between items-center p-2 border border-gray-200 rounded-lg mb-2';
                    fileItem.innerHTML = `
                        <div class="truncate max-w-[70%]">
                            <p class="font-medium text-sm">${file.name}</p>
                            <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                        <button class="text-red-500 text-sm delete-btn" data-index="${index}">åˆ é™¤</button>
                    `;
                    fileList.appendChild(fileItem);
                });

                // ç»‘å®šåˆ é™¤äº‹ä»¶
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = e.target.dataset.index;
                        selectedFiles.splice(index, 1);
                        e.target.parentElement.remove();
                    });
                });
            });

            // è½¬æ¢æ–‡ä»¶
            const convertBtn = document.getElementById('convertBtn');
            convertBtn.addEventListener('click', async () => {
                if (!isFFmpegLoaded) {
                    alert('è¯·å…ˆåŠ è½½FFmpegè½¬æ¢æ ¸å¿ƒ');
                    return;
                }
                if (selectedFiles.length === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è¦è½¬æ¢çš„æ–‡ä»¶');
                    return;
                }

                const outputFormat = document.getElementById('formatSelect').value;
                const statusText = document.getElementById('statusText');
                const downloadArea = document.getElementById('downloadArea');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                // é‡ç½®è¿›åº¦å’Œä¸‹è½½åŒº
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                downloadArea.innerHTML = '';
                statusText.textContent = 'å¼€å§‹è½¬æ¢æ–‡ä»¶...';
                statusText.className = 'text-blue-600 text-sm mt-2';
                convertBtn.disabled = true;
                convertBtn.textContent = 'è½¬æ¢ä¸­...';

                try {
                    // æ‰¹é‡å¤„ç†æ–‡ä»¶
                    for (let i = 0; i < selectedFiles.length; i++) {
                        const file = selectedFiles[i];
                        statusText.textContent = `æ­£åœ¨è½¬æ¢ ${i+1}/${selectedFiles.length}ï¼š${file.name}`;
                        
                        // æå–æ–‡ä»¶åï¼ˆä¸å«åç¼€ï¼‰
                        const fileName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                        const inputFileName = `input_${i}_${file.name}`;
                        const outputFileName = `${fileName}.${outputFormat}`;

                        // å†™å…¥æ–‡ä»¶åˆ°FFmpegè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ
                        await ffmpeg.writeFile(inputFileName, await fetchFile(file));
                        
                        // æ‰§è¡Œè½¬æ¢å‘½ä»¤
                        await ffmpeg.exec(['-i', inputFileName, outputFileName]);
                        
                        // è¯»å–è½¬æ¢åçš„æ–‡ä»¶
                        const data = await ffmpeg.readFile(outputFileName);
                        const blob = new Blob([data.buffer], { type: getMimeType(outputFormat) });
                        const url = URL.createObjectURL(blob);

                        // ç”Ÿæˆä¸‹è½½é¡¹
                        const downloadItem = document.createElement('div');
                        downloadItem.className = 'flex justify-between items-center p-3 bg-green-50 border border-green-200 rounded-lg mb-2';
                        downloadItem.innerHTML = `
                            <p class="font-medium text-sm truncate max-w-[70%]">${outputFileName}</p>
                            <a href="${url}" download="${outputFileName}" class="bg-green-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-700 transition-colors">
                                ä¸‹è½½æ–‡ä»¶
                            </a>
                        `;
                        downloadArea.appendChild(downloadItem);

                        // æ¸…ç†è™šæ‹Ÿæ–‡ä»¶
                        await ffmpeg.deleteFile(inputFileName);
                        await ffmpeg.deleteFile(outputFileName);
                    }

                    statusText.textContent = `âœ… å…¨éƒ¨è½¬æ¢å®Œæˆï¼Œå…±è½¬æ¢ ${selectedFiles.length} ä¸ªæ–‡ä»¶`;
                    statusText.className = 'text-green-600 text-sm mt-2 font-medium';
                } catch (error) {
                    console.error(error);
                    statusText.textContent = 'âŒ è½¬æ¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåã€æ ¼å¼æ˜¯å¦å…¼å®¹';
                    statusText.className = 'text-red-500 text-sm mt-2';
                } finally {
                    convertBtn.disabled = false;
                    convertBtn.textContent = 'å¼€å§‹è½¬æ¢';
                }
            });
        };

        // æ ¹æ®åç¼€è·å–MIMEç±»å‹
        function getMimeType(format) {
            const mimeMap = {
                // è§†é¢‘
                mp4: 'video/mp4',
                avi: 'video/x-msvideo',
                mkv: 'video/x-matroska',
                webm: 'video/webm',
                mov: 'video/quicktime',
                flv: 'video/x-flv',
                // éŸ³é¢‘
                mp3: 'audio/mpeg',
                wav: 'audio/wav',
                ogg: 'audio/ogg',
                flac: 'audio/flac',
                aac: 'audio/aac',
                m4a: 'audio/m4a',
                // å›¾ç‰‡
                jpg: 'image/jpeg',
                png: 'image/png',
                webp: 'image/webp',
                gif: 'image/gif',
                bmp: 'image/bmp',
                tiff: 'image/tiff'
            };
            return mimeMap[format] || 'application/octet-stream';
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å¤´éƒ¨ -->
    <header class="bg-blue-600 text-white py-5 shadow-md">
        <div class="container mx-auto px-4 max-w-4xl">
            <h1 class="text-[clamp(1.5rem,3vw,2.2rem)] font-bold">ğŸ“½ï¸ æ ¼å¼å·¥å‚</h1>
            <p class="text-sm mt-1 opacity-90">æµè§ˆå™¨æœ¬åœ°è¿è¡Œ | éŸ³è§†é¢‘å›¾ç‰‡å…¨æ ¼å¼è½¬æ¢ | éšç§å®‰å…¨ä¸ä¸Šä¼ </p>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- æ ¸å¿ƒåŠ è½½åŒº -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3">
                <div>
                    <h2 class="font-semibold text-gray-800">è½¬æ¢æ ¸å¿ƒçŠ¶æ€</h2>
                    <p id="statusText" class="text-gray-500 text-sm mt-1">æœªåŠ è½½æ ¸å¿ƒï¼Œç‚¹å‡»å³ä¾§æŒ‰é’®åŠ è½½åå³å¯ä½¿ç”¨</p>
                </div>
                <button id="loadFFmpegBtn" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-medium hover:bg-blue-700 transition-colors w-full sm:w-auto">
                    åŠ è½½è½¬æ¢æ ¸å¿ƒ
                </button>
            </div>
            <!-- è¿›åº¦æ¡ -->
            <div class="w-full h-2 bg-gray-100 rounded-full mt-4 overflow-hidden">
                <div id="progressBar" class="h-full bg-blue-600 transition-all duration-300 w-0"></div>
            </div>
            <div class="text-right text-xs text-gray-500 mt-1">
                <span id="progressText">0%</span>
            </div>
        </div>

        <!-- è½¬æ¢ç±»å‹é€‰æ‹© -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">é€‰æ‹©è½¬æ¢ç±»å‹</h2>
            <div class="grid grid-cols-3 gap-3">
                <button class="type-btn bg-blue-600 text-white rounded-lg p-4 font-medium transition-all hover:shadow-md" data-type="video">
                    ğŸ¬ è§†é¢‘è½¬æ¢
                </button>
                <button class="type-btn bg-white text-gray-700 border border-gray-200 rounded-lg p-4 font-medium transition-all hover:shadow-md" data-type="audio">
                    ğŸµ éŸ³é¢‘è½¬æ¢
                </button>
                <button class="type-btn bg-white text-gray-700 border border-gray-200 rounded-lg p-4 font-medium transition-all hover:shadow-md" data-type="image">
                    ğŸ–¼ï¸ å›¾ç‰‡è½¬æ¢
                </button>
            </div>
        </div>

        <!-- æ–‡ä»¶é€‰æ‹©åŒº -->
        <div class="bg-white rounded-xl shadow-sm p-5 mb-6 border border-gray-200">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-3 mb-4">
                <h2 class="font-semibold text-gray-800 w-full sm:w-auto">é€‰æ‹©æ–‡ä»¶</h2>
                <div class="flex gap-2 w-full sm:w-auto">
                    <select id="formatSelect" class="border border-gray-300 rounded-lg px-3 py-2 outline-none focus:border-blue-500 disabled:bg-gray-100" disabled>
                        <option value="mp4">MP4</option>
                        <option value="avi">AVI</option>
                        <option value="mkv">MKV</option>
                        <option value="webm">WebM</option>
                        <option value="mov">MOV</option>
                        <option value="flv">FLV</option>
                    </select>
                    <label for="fileInput" class="bg-gray-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors text-center">
                        æ·»åŠ æ–‡ä»¶
                    </label>
                    <input type="file" id="fileInput" class="hidden" multiple disabled accept="video/*">
                </div>
            </div>

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div id="fileList" class="max-h-60 overflow-y-auto"></div>
            <div id="emptyTip" class="text-center py-8 text-gray-400 text-sm">
                æš‚æ— æ–‡ä»¶ï¼Œç‚¹å‡»ä¸Šæ–¹ã€Œæ·»åŠ æ–‡ä»¶ã€é€‰æ‹©è¦è½¬æ¢çš„æ–‡ä»¶
            </div>
        </div>

        <!-- è½¬æ¢æŒ‰é’® -->
        <button id="convertBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed mb-6" disabled>
            å¼€å§‹è½¬æ¢
        </button>

        <!-- ä¸‹è½½åŒº -->
        <div class="mb-8">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">è½¬æ¢å®Œæˆæ–‡ä»¶</h2>
            <div id="downloadArea" class="min-h-[100px]"></div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-sm text-gray-600">
            <h3 class="font-semibold mb-2">ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <ul class="list-disc pl-5 space-y-1">
                <li>é¦–æ¬¡ä½¿ç”¨éœ€ç‚¹å‡»ã€ŒåŠ è½½è½¬æ¢æ ¸å¿ƒã€ï¼Œæ ¸å¿ƒæ–‡ä»¶çº¦30MBï¼Œä»…é¦–æ¬¡åŠ è½½éœ€è¦ç½‘ç»œ</li>
                <li>æ‰€æœ‰è½¬æ¢å‡åœ¨ä½ çš„æœ¬åœ°æµè§ˆå™¨å®Œæˆï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨ï¼Œéšç§å®‰å…¨</li>
                <li>æ”¯æŒæ‰¹é‡è½¬æ¢ï¼Œå¯åŒæ—¶æ·»åŠ å¤šä¸ªåŒç±»å‹æ–‡ä»¶</li>
                <li>å¤§æ–‡ä»¶è½¬æ¢é€Ÿåº¦å–å†³äºä½ çš„ç”µè„‘é…ç½®ï¼Œå»ºè®®å•æ–‡ä»¶ä¸è¶…è¿‡2GB</li>
                <li>å¦‚æœæœ¬åœ°æ‰“å¼€æŠ¥é”™ï¼Œè¯·ä½¿ç”¨Chrome/Edgeæµè§ˆå™¨ï¼Œæˆ–ç”¨æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€</li>
            </ul>
        </div>
    </main>
</body>
              </html>
